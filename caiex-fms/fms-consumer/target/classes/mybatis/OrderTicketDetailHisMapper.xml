<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.caiex.account.mapper.OrderTicketDetailHisMapper" > 
<!-- Result Map-->
<resultMap id="BaseResultMap" type="com.caiex.account.entity.OrderTicketDetailHis" >
	<result column="local_m" property="local_m"/>
	<result column="total_price" property="total_price"/>
	<result column="sid" property="sid"/>
	<result column="tid" property="tid"/>
	<result column="inv_allup" property="inv_allup"/>
	<result column="price_allup" property="price_allup"/>
	<result column="status" property="status"/>
	<result column="alive_m" property="alive_m"/>
	<result column="product" property="product"/>
	<result column="payouttime" property="payouttime"/>
</resultMap>
<resultMap id="BaseResultMapStatement" type="com.caiex.account.entity.OrderTicketDetailHis" >
	<result column="local_m" property="local_m"/>
	<result column="total_price" property="total_price"/>
	<result column="sid" property="sid"/>
	<result column="tid" property="tid"/>
	<result column="inv_allup" property="inv_allup"/>
	<result column="price_allup" property="price_allup"/>
	<result column="status" property="status"/>
	<result column="alive_m" property="alive_m"/>
	<result column="product" property="product"/>
	<result column="payouttime" property="payouttime"/>
	<result column="weekDate" property="weekDate"/>
	<result column="matchNum" property="matchNum"/>
	<result column="pl" property="pl"/>
	
</resultMap>       
<!-- order_ticket_detail_his table all fields -->
<sql id="Base_Column_List" >
	 local_m,total_price,sid,tid,inv_allup,price_allup,status,alive_m,product,payouttime
</sql>
   
   
<!-- 查询条件 -->
<sql id="Example_Where_Clause">
where 1=1
<trim  suffixOverrides="," >
	<if test="local_m != null" >
	    and local_m =  #{local_m}
	</if>
	<if test="total_price != null" >
	    and total_price =  #{total_price}
	</if>
	<if test="sid != null" >
	    and sid =  #{sid}
	</if>
	<if test="tid != null" >
	    and tid =  #{tid}
	</if>
	<if test="inv_allup != null" >
	    and inv_allup =  #{inv_allup}
	</if>
	<if test="price_allup != null" >
	    and price_allup =  #{price_allup}
	</if>
	<if test="status != null" >
	    and status =  #{status}
	</if>
	<if test="alive_m != null" >
	    and alive_m =  #{alive_m}
	</if>
	 	<if test="product != null and product != ''" >
	    and product =  #{product}
	</if>
	<if test="payouttime != null" >
	    and payouttime =  #{payouttime}
	</if>
</trim>
</sql>
   

<!-- 插入记录 -->
<insert id="add" parameterType="Object" >
  <selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
	SELECT LAST_INSERT_ID()
  </selectKey>
  insert into order_ticket_detail_his(local_m,total_price,sid,tid,inv_allup,price_allup,status,alive_m,product,payouttime)
 values(#{local_m},#{total_price},#{sid},#{tid},#{inv_allup},#{price_allup},#{status},#{alive_m},#{product},#{payouttime})
</insert>

<!-- 根据id，修改记录-->  
 <update id="update" parameterType="Object" >
  update order_ticket_detail_his set total_price=#{total_price},sid=#{sid},tid=#{tid},inv_allup=#{inv_allup},price_allup=#{price_allup},status=#{status},alive_m=#{alive_m},product=#{product},payouttime=#{payouttime} where local_m=#{local_m}
 </update>
 
 <!-- 修改记录，只修改只不为空的字段 -->
<update id="updateBySelective" parameterType="Object" >
	update order_ticket_detail_his set 
	<trim  suffixOverrides="," >
	<if test="total_price != null  ">
		total_price=#{total_price},
	</if>
	<if test="sid != null  ">
		sid=#{sid},
	</if>
	<if test="tid != null  ">
		tid=#{tid},
	</if>
	<if test="inv_allup != null  ">
		inv_allup=#{inv_allup},
	</if>
	<if test="price_allup != null  ">
		price_allup=#{price_allup},
	</if>
	<if test="status != null  ">
		status=#{status},
	</if>
	<if test="alive_m != null  ">
		alive_m=#{alive_m},
	</if>
	<if test="product != null  and product != '' ">
		product=#{product},
	</if>
	<if test="payouttime != null  ">
		payouttime=#{payouttime},
	</if>
	</trim> where local_m=#{local_m}
</update>

<!-- 删除记录 -->
<delete id="delete" parameterType="Object">
	delete 	 from order_ticket_detail_his where local_m = #{local_m}
</delete>
 
<!-- 根据id查询 票明细历史记录 -->
<select id="queryById"  resultMap="BaseResultMap" parameterType="Object">
	select <include refid="Base_Column_List" /> 
	 from order_ticket_detail_his where local_m = #{local_m}
</select>

<!-- 票明细历史记录 列表总数-->
<select id="queryByCount" resultType="java.lang.Integer"  parameterType="Object">
	select count(1) from order_ticket_detail_his 
	<include refid="Example_Where_Clause"/>
</select>
  	
<!-- 查询票明细历史记录列表 -->
<select id="queryByList" resultMap="BaseResultMap"  parameterType="Object">
	select 
	<include refid="Base_Column_List"/>
	from order_ticket_detail_his 
	<include refid="Example_Where_Clause"/>
	<if test="pager.orderCondition != null and pager.orderCondition != ''" >
      ${pager.orderCondition}
    </if>
    <if test="pager.mysqlQueryCondition != null and pager.mysqlQueryCondition != ''" >
       ${pager.mysqlQueryCondition}
    </if>
</select>

<!-- 批量迁移match_product_his表 -->
<insert id="batchAdd" useGeneratedKeys="false" parameterType="java.util.List">  
  insert into order_ticket_detail_his(local_m,total_price,sid,tid,inv_allup,price_allup,status,alive_m,product,payouttime,week_id)
	values  
        <foreach collection="list" item="item" index="index" separator="," >  
	(#{item.local_m},#{item.total_price},#{item.sid},#{item.tid},#{item.inv_allup},#{item.price_allup},#{item.status},#{item.alive_m},#{item.product},#{item.payouttime},#{item.week_id})
        </foreach>  
  </insert>
  	
  	
  	
<!--summary  -->
   <!--根据时间统计场次数量-->
<select id="queryMatchNum" resultType="java.lang.Integer"  parameterType="Object">

select sum(c.mid) from (
select count(a.mid)as mid from(select distinct(h.mid) from match_product_his h where <![CDATA[ h.payouttime  >=#{startDate}  ]]>  <![CDATA[ and h.payouttime < #{endDate}]]>)  a union all
select count(b.mid)as mid from(select distinct(p.mid) from match_product p where <![CDATA[ p.payouttime  >=#{startDate}  ]]>  <![CDATA[ and p.payouttime < #{endDate}]]>)  b
) c	
</select> 




		 <!--根据时间查询赛事日数-->
<select id="queryMatchNumList" resultMap="BaseResultMapStatement"  parameterType="Object">

select count(a.mid) from(select distinct(p.mid) from match_product_his p where <![CDATA[ p.payouttime  >=#{startDate}  ]]>  <![CDATA[ and p.payouttime < #{endDate}]]>)  a

</select> 






<select id="detailHisQuery" resultMap="BaseResultMap"  parameterType="Object">
	select d.price_allup from order_ticket_detail_his d INNER JOIN order_ticket_matches_his e on e.sid=d.sid

where d.week_id =#{week_id} and d.local_m=1 and e.l_code =#{match_code} and d.status in (1,2) and d.product=#{product}
UNION all 
select d.total_price from order_ticket_detail_his d INNER JOIN order_ticket_matches_his e on e.sid=d.sid

where d.week_id =#{week_id} and d.local_m=1 and e.l_code =#{match_code} and d.status=1 and d.product=#{product}
UNION all
select d.price_allup as invest1 from order_ticket_detail_his d INNER JOIN order_ticket_matches_his e on e.sid=d.sid

where d.week_id =#{week_id} and d.local_m=1 and e.l_code =#{match_code} and d.status=1  and d.product=#{product}
  
</select>


<!-- single -->
<select id="detailHisQueryInvest" resultMap="BaseResultMap"  parameterType="com.caiex.account.entity.MatchInfoHis">
select SUM(a.price_allup) AS  price_allup from (
	select SUM(d.price_allup) AS  price_allup from order_ticket_detail_his d INNER JOIN order_ticket_matches_his e on e.sid=d.sid

	<!-- where d.local_m=1 and e.l_code =#{match_code} and d.status in (1,2) and d.product=#{product} --> 
	<include refid="Where_queryTotalInvestmentFSGL"/> and e.sid in 
	<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
            #{item.sid}
    </foreach>
   
	union all 

	select SUM(d.price_allup) AS  price_allup from order_ticket_detail d INNER JOIN order_ticket_matches e on e.sid=d.sid
	
	<!-- where d.local_m=1 and e.l_code =#{match_code} and d.status in (1,2) and d.product=#{product}  -->
	<include refid="Where_queryTotalInvestmentFSGL"/> and e.sid in 
	
	<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
            #{item.sid}
    </foreach>
	) as a
</select>


    <!-- 查询条件 -->
<sql id="Where_queryTotalInvestmentFSGL">
where 1=1
<trim  suffixOverrides="," >
	<if test="match_code != null and match_code != '' " >
	    and <![CDATA[ e.l_code =#{match_code} ]]> 
	</if>
	<if test="product != null and product != '' " >
    and d.product=#{product}
	</if>
	 and d.local_m=1 and d.status in (1,2)
</trim>
</sql>
    




<select id="detailHisQueryTotalPrice" resultMap="BaseResultMap"  parameterType="com.caiex.account.entity.MatchInfoHis">
	select SUM(a.total_price) AS  total_price from ( 
		select SUM(d.total_price) AS  total_price from order_ticket_detail_his d INNER JOIN order_ticket_matches_his e on e.sid=d.sid
		
		<!-- where d.local_m=1 and e.l_code =#{match_code} and d.status=1 and d.product=#{product} --> 
		<include refid="Where_queryTotalPriceFSGL"/>
		and e.sid in
		<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
            #{item.sid}
    	</foreach>
		union all
		select SUM(d.total_price) AS  total_price from order_ticket_detail d INNER JOIN order_ticket_matches e on e.sid=d.sid
		
		<!-- where d.local_m=1 and e.l_code =#{match_code} and d.status=1 and d.product=#{product}  -->
		<include refid="Where_queryTotalPriceFSGL"/>
		and e.sid in
		<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
            #{item.sid}
    </foreach>
 	) as a
</select>

  <!-- 查询条件 -->
<sql id="Where_queryTotalPriceFSGL">
where 1=1
<trim  suffixOverrides="," >
	<if test="match_code != null and match_code != '' " >
	    and <![CDATA[ e.l_code =#{match_code} ]]> 
	</if>
	<if test="product != null and product != '' " >
    and d.product=#{product}
	</if>
	 and d.local_m=1 and d.status=1
</trim>
</sql>






<select id="detailHisQueryWinInvest" resultMap="BaseResultMap"  parameterType="com.caiex.account.entity.MatchInfoHis">
select SUM(a.price_allup) AS price_allup  from (
	select SUM(d.price_allup) AS price_allup  from order_ticket_detail_his d INNER JOIN order_ticket_matches_his e on e.sid=d.sid
	
	<!-- where   d.local_m=1 and e.l_code =#{match_code} and d.status=1  and d.product=#{product}  --> 
	<include refid="Where_queryWinInvestFSGL"/>
	and  e.sid in
	<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
            #{item.sid}
    </foreach>
	union all
	select SUM(d.price_allup) AS price_allup  from order_ticket_detail d INNER JOIN order_ticket_matches e on e.sid=d.sid
	
	<!-- where   d.local_m=1 and e.l_code =#{match_code} and d.status=1  and d.product=#{product} --> 
	<include refid="Where_queryWinInvestFSGL"/>
	and  e.sid in
	<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
            #{item.sid}
    </foreach>
) as a
</select>

<sql id="Where_queryWinInvestFSGL">
where 1=1
<trim  suffixOverrides="," >
	<if test="match_code != null and match_code != '' " >
	    and <![CDATA[ e.l_code =#{match_code} ]]> 
	</if>
	<if test="product != null and product != '' " >
    and d.product=#{product}
	</if>
	 and d.local_m=1 and d.status=1
</trim>
</sql>


	<!--单关的totalInvestment -->
<select id="detailHisQueryTotalInvestment" resultMap="BaseResultMap"  parameterType="com.caiex.account.entity.MatchInfoHis">
	select SUM(f.inv_allup) as inv_allup from (

			select SUM(d.inv_allup) as inv_allup  from order_ticket_detail_his d INNER JOIN order_ticket_matches_his e on e.sid=d.sid
		
			<!-- where d.local_m=1 and e.l_code =#{match_code}  and d.product=#{product} --> 
			<include refid="Where_querydetailTotalInvestment"/>
			and e.sid in 
			<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
		            #{item.sid}
		    </foreach>
			
			union all 
		
			select SUM(d.inv_allup) as inv_allup  from order_ticket_detail d INNER JOIN order_ticket_matches e on e.sid=d.sid
			<!-- where d.local_m=1 and e.l_code =#{match_code}  and d.product=#{product}  --> 
			<include refid="Where_querydetailTotalInvestment"/>
			and e.sid in 
			<foreach item="item" index="index" collection="sids" open="(" separator="," close=")">
		            #{item.sid}
		    </foreach>
		) as f

</select>

<sql id="Where_querydetailTotalInvestment">
where 1=1
<trim  suffixOverrides="," >
	<if test="match_code != null and match_code != '' " >
	    and <![CDATA[ e.l_code =#{match_code} ]]> 
	</if>
	<if test="product != null and product != '' " >
    and d.product=#{product}
	</if>
	 and d.local_m=1 
</trim>
</sql>


<!--single  -->




<select id="queryDetailHisByPayouttime" resultMap="BaseResultMap"  parameterType="java.util.Map">
	
select <include refid="Base_Column_List"/> from order_ticket_detail_his d where  <![CDATA[ d.payouttime  >=#{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]>  and d.local_m=1
union all
select <include refid="Base_Column_List"/> from order_ticket_detail d where  <![CDATA[ d.payouttime  >=#{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]>  and d.local_m=1

</select>

 <!-- 查询串关数据 -->
<select id="queryAllup" resultMap="BaseResultMap"  parameterType="Object">
SELECT
	2 AS local_m,
	(
		SELECT
			sum(b.inv_allup) AS totalInvestment
		FROM
			(
						SELECT
						SUM(d.inv_allup) as inv_allup
								FROM
									order_ticket_detail_his d
								WHERE
									1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
								AND d.product = #{product} 
								AND d.local_m = 2
								UNION ALL
									SELECT
										SUM(d.inv_allup) as inv_allup
									FROM
										order_ticket_detail d
									WHERE
										1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
									AND d.product = #{product} 
									AND d.local_m = 2
							) AS b
	) AS totalInvestment,
	(
		SELECT
			sum(a.price_allup) AS price_allup
		FROM
			(
				SELECT
					sum(d.price_allup) AS price_allup
				FROM
					order_ticket_detail_his d
				WHERE
					1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
				AND d.product = #{product} 
				AND d. STATUS != 3
				AND d.local_m = 2
				UNION ALL
					SELECT
						sum(d.price_allup) AS price_allup
					FROM
						order_ticket_detail d
					WHERE
						1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
					AND d.product = #{product} 
					AND d. STATUS != 3
					AND d.local_m = 2
			) AS a
	) AS price_allup,
	(
		SELECT
			sum(a.total_price) AS total_price
		FROM
			(
				SELECT
					sum(d.total_price) AS total_price
				FROM
					order_ticket_detail_his d
				WHERE
					1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
				AND d.product = #{product} 
				AND d. STATUS = 1
				AND d.local_m = 2
				UNION ALL
					SELECT
						sum(d.total_price) AS total_price
					FROM
						order_ticket_detail d
					WHERE
						1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
					AND d.product = #{product} 
					AND d. STATUS = 1
					AND d.local_m = 2
			) AS a
	) AS total_price
FROM
	DUAL
UNION ALL
	SELECT
		3 AS local_m,
		(
			SELECT
				sum(b.inv_allup) AS totalInvestment
			FROM
				(
					
									SELECT
										SUM(d.inv_allup) as inv_allup
									FROM
										order_ticket_detail_his d
									WHERE
										1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
									AND d.product = #{product} 
									AND d.local_m = 3
									UNION ALL
										SELECT
											SUM(d.inv_allup) as inv_allup
										FROM
											order_ticket_detail d
										WHERE
											1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
										AND d.product = #{product} 
										AND d.local_m = 3
								) AS b
						
		) AS totalInvestment,
		(
			SELECT
				sum(a.price_allup) AS price_allup
			FROM
				(
					SELECT
						sum(d.price_allup) AS price_allup
					FROM
						order_ticket_detail_his d
					WHERE
						1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
					AND d.product = #{product} 
					AND d. STATUS != 3
					AND d.local_m = 3
					UNION ALL
						SELECT
							sum(d.price_allup) AS price_allup
						FROM
							order_ticket_detail d
						WHERE
							1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
						AND d.product = #{product} 
						AND d. STATUS != 3
						AND d.local_m = 3
				) AS a
		) AS price_allup,
		(
			SELECT
				sum(a.total_price) AS total_price
			FROM
				(
					SELECT
						sum(d.total_price) AS total_price
					FROM
						order_ticket_detail_his d
					WHERE
						1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
					AND d.product = #{product} 
					AND d. STATUS = 1
					AND d.local_m = 3
					UNION ALL
						SELECT
							sum(d.total_price) AS total_price
						FROM
							order_ticket_detail d
						WHERE
							1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
						AND d.product = #{product} 
						AND d. STATUS = 1
						AND d.local_m = 3
				) AS a
		) AS total_price
	FROM
		DUAL
	UNION ALL
		SELECT
			4 AS local_m,
			(
				SELECT
					sum(b.inv_allup) AS totalInvestment
				FROM
					(
										SELECT
											SUM(d.inv_allup) as inv_allup
										FROM
											order_ticket_detail_his d
										WHERE
											1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
										AND d.product = #{product} 
										AND d.local_m = 4
										UNION ALL
											SELECT
												SUM(d.inv_allup) as inv_allup
											FROM
												order_ticket_detail d
											WHERE
												1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
											AND d.product = #{product} 
											AND d.local_m = 4
									) AS b
							
			) AS totalInvestment,
			(
				SELECT
					sum(a.price_allup) AS price_allup
				FROM
					(
						SELECT
							sum(d.price_allup) AS price_allup
						FROM
							order_ticket_detail_his d
						WHERE
							1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
						AND d.product = #{product} 
						AND d. STATUS != 3
						AND d.local_m = 4
						UNION ALL
							SELECT
								sum(d.price_allup) AS price_allup
							FROM
								order_ticket_detail d
							WHERE
								1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
							AND d.product = #{product} 
							AND d. STATUS != 3
							AND d.local_m = 4
					) AS a
			) AS price_allup,
			(
				SELECT
					sum(a.total_price) AS total_price
				FROM
					(
						SELECT
							sum(d.total_price) AS total_price
						FROM
							order_ticket_detail_his d
						WHERE
							1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
						AND d.product = #{product} 
						AND d. STATUS = 1
						AND d.local_m = 4
						UNION ALL
							SELECT
								sum(d.total_price) AS total_price
							FROM
								order_ticket_detail d
							WHERE
								1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
							AND d.product = #{product} 
							AND d. STATUS = 1
							AND d.local_m = 4
					) AS a
			) AS total_price
		FROM
			DUAL
		UNION ALL
			SELECT
				5 AS local_m,
				(
					SELECT
						sum(b.inv_allup) AS totalInvestment
					FROM
						(
							
											SELECT
												SUM(d.inv_allup) as inv_allup
											FROM
												order_ticket_detail_his d
											WHERE
												1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
											AND d.product = #{product} 
											AND d.local_m = 5
											UNION ALL
												SELECT
													SUM(d.inv_allup) as inv_allup
												FROM
													order_ticket_detail d
												WHERE
													1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
												AND d.product = #{product} 
												AND d.local_m = 5
						) AS b
				) AS totalInvestment,
				(
					SELECT
						sum(a.price_allup) AS price_allup
					FROM
						(
							SELECT
								sum(d.price_allup) AS price_allup
							FROM
								order_ticket_detail_his d
							WHERE
								1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
							AND d.product = #{product} 
							AND d. STATUS != 3
							AND d.local_m = 5
							UNION ALL
								SELECT
									sum(d.price_allup) AS price_allup
								FROM
									order_ticket_detail d
								WHERE
									1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
								AND d.product = #{product} 
								AND d. STATUS != 3
								AND d.local_m = 5
						) AS a
				) AS price_allup,
				(
					SELECT
						sum(a.total_price) AS total_price
					FROM
						(
							SELECT
								sum(d.total_price) AS total_price
							FROM
								order_ticket_detail_his d
							WHERE
								1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
							AND d.product = #{product} 
							AND d. STATUS = 1
							AND d.local_m = 5
							UNION ALL
								SELECT
									sum(d.total_price) AS total_price
								FROM
									order_ticket_detail d
								WHERE
									1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
								AND d.product = #{product} 
								AND d. STATUS = 1
								AND d.local_m = 5
						) AS a
				) AS total_price
			FROM
				DUAL
			UNION ALL
				SELECT
					6 AS local_m,
					(
						SELECT
							sum(b.inv_allup) AS totalInvestment
						FROM
							(
												SELECT
													SUM(d.inv_allup) as inv_allup
												FROM
													order_ticket_detail_his d
												WHERE
													1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
												AND d.product = #{product} 
												AND d.local_m = 6
												UNION ALL
													SELECT
														SUM(d.inv_allup) as inv_allup
													FROM
														order_ticket_detail d
													WHERE
														1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
													AND d.product = #{product} 
													AND d.local_m = 6
											
							) AS b
					) AS totalInvestment,
					(
						SELECT
							sum(a.price_allup) AS price_allup
						FROM
							(
								SELECT
									sum(d.price_allup) AS price_allup
								FROM
									order_ticket_detail_his d
								WHERE
									1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
								AND d.product = #{product} 
								AND d. STATUS != 3
								AND d.local_m = 6
								UNION ALL
									SELECT
										sum(d.price_allup) AS price_allup
									FROM
										order_ticket_detail d
									WHERE
										1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
									AND d.product = #{product} 
									AND d. STATUS != 3
									AND d.local_m = 6
							) AS a
					) AS price_allup,
					(
						SELECT
							sum(a.total_price) AS total_price
						FROM
							(
								SELECT
									sum(d.total_price) AS total_price
								FROM
									order_ticket_detail_his d
								WHERE
									1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
								AND d.product = #{product} 
								AND d. STATUS = 1
								AND d.local_m = 6
								UNION ALL
									SELECT
										sum(d.total_price) AS total_price
									FROM
										order_ticket_detail d
									WHERE
										1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
									AND d.product = #{product} 
									AND d. STATUS = 1
									AND d.local_m = 6
							) AS a
					) AS total_price
				FROM
					DUAL
				UNION ALL
					SELECT
						7 AS local_m,
						(
							SELECT
								sum(b.inv_allup) AS totalInvestment
							FROM
								(
								
													SELECT
														SUM(d.inv_allup) as inv_allup
													FROM
														order_ticket_detail_his d
													WHERE
														1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
													AND d.product = #{product} 
													AND d.local_m = 7
													UNION ALL
														SELECT
															SUM(d.inv_allup) as inv_allup
														FROM
															order_ticket_detail d
														WHERE
															1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
														AND d.product = #{product} 
														AND d.local_m = 7
												
								) AS b
						) AS totalInvestment,
						(
							SELECT
								sum(a.price_allup) AS price_allup
							FROM
								(
									SELECT
										sum(d.price_allup) AS price_allup
									FROM
										order_ticket_detail_his d
									WHERE
										1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
									AND d.product = #{product} 
									AND d. STATUS != 3
									AND d.local_m = 7
									UNION ALL
										SELECT
											sum(d.price_allup) AS price_allup
										FROM
											order_ticket_detail d
										WHERE
											1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
										AND d.product = #{product} 
										AND d. STATUS != 3
										AND d.local_m = 7
								) AS a
						) AS price_allup,
						(
							SELECT
								sum(a.total_price) AS total_price
							FROM
								(
									SELECT
										sum(d.total_price) AS total_price
									FROM
										order_ticket_detail_his d
									WHERE
										1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
									AND d.product = #{product} 
									AND d. STATUS = 1
									AND d.local_m = 7
									UNION ALL
										SELECT
											sum(d.total_price) AS total_price
										FROM
											order_ticket_detail d
										WHERE
											1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
										AND d.product = #{product} 
										AND d. STATUS = 1
										AND d.local_m = 7
								) AS a
						) AS total_price
					FROM
						DUAL
					UNION ALL
						SELECT
							8 AS local_m,
							(
								SELECT
									sum(b.inv_allup) AS totalInvestment
								FROM
									(
														SELECT
															SUM(d.inv_allup) as inv_allup
														FROM
															order_ticket_detail_his d
														WHERE
															1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
														AND d.product = #{product} 
														AND d.local_m = 8
														UNION ALL
															SELECT
																SUM(d.inv_allup) as inv_allup
															FROM
																order_ticket_detail d
															WHERE
																1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
															AND d.product = #{product} 
															AND d.local_m = 8
													
									) AS b
							) AS totalInvestment,
							(
								SELECT
									sum(a.price_allup) AS price_allup
								FROM
									(
										SELECT
											sum(d.price_allup) AS price_allup
										FROM
											order_ticket_detail_his d
										WHERE
											1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
										AND d.product = #{product} 
										AND d. STATUS != 3
										AND d.local_m = 8
										UNION ALL
											SELECT
												sum(d.price_allup) AS price_allup
											FROM
												order_ticket_detail d
											WHERE
												1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
											AND d.product = #{product} 
											AND d. STATUS != 3
											AND d.local_m = 8
									) AS a
							) AS price_allup,
							(
								SELECT
									sum(a.total_price) AS total_price
								FROM
									(
										SELECT
											sum(d.total_price) AS total_price
										FROM
											order_ticket_detail_his d
										WHERE
											1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
										AND d.product = #{product} 
										AND d. STATUS = 1
										AND d.local_m = 8
										UNION ALL
											SELECT
												sum(d.total_price) AS total_price
											FROM
												order_ticket_detail d
											WHERE
												1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
											AND d.product = #{product} 
											AND d. STATUS = 1
											AND d.local_m = 8
									) AS a
							) AS total_price
						UNION ALL
							SELECT
								9 AS local_m,
								(
								SELECT
									sum(b.inv_allup) AS totalInvestment
								FROM
									(
										SELECT
															SUM(d.inv_allup) as inv_allup
														FROM
															order_ticket_detail_his d
														WHERE
															1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
														AND d.product = #{product} 
														AND d.local_m > 1
														UNION ALL
															SELECT
																SUM(d.inv_allup) as inv_allup
															FROM
																order_ticket_detail d
															WHERE
																1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
															AND d.product = #{product} 
															AND d.local_m > 1
													
									) AS b
							) AS totalInvestment,
								(
									SELECT
										sum(a.price_allup) AS price_allup
									FROM
										(
											SELECT
												sum(d.price_allup) AS price_allup
											FROM
												order_ticket_detail_his d
											WHERE
												1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
											AND d.product = #{product} 
											AND d. STATUS != 3
											AND d.local_m > 1
											UNION ALL
												SELECT
													sum(d.price_allup) AS price_allup
												FROM
													order_ticket_detail d
												WHERE
													1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
												AND d.product = #{product} 
												AND d. STATUS != 3
												AND d.local_m > 1
										) AS a
								) AS price_allup,
								(
									SELECT
										sum(a.total_price) AS total_price
									FROM
										(
											SELECT
												sum(d.total_price) AS total_price
											FROM
												order_ticket_detail_his d
											WHERE
												1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
											AND d.product = #{product} 
											AND d. STATUS = 1
											AND d.local_m > 1
											UNION ALL
												SELECT
													sum(d.total_price) AS total_price
												FROM
													order_ticket_detail d
												WHERE
													1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
												AND d.product = #{product} 
												AND d. STATUS = 1
												AND d.local_m > 1
										) AS a
								) AS total_price
</select>


<select id="queryTotalInvests" resultMap="BaseResultMap"  parameterType="Object">
	
	SELECT
	sum(b.totalInvestment) AS totalInvestment
	FROM
	(
	SELECT
	SUM(f.totalInvestment) AS totalInvestment
	FROM
	order_ticket_info f
	WHERE
	f.id IN (
	SELECT DISTINCT
	(a.tid)
	FROM
	(
	SELECT
	d.tid
	FROM
	order_ticket_detail_his d
	WHERE
	1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]>
	AND d.local_m > 1
	UNION ALL
	SELECT
	d.tid
	FROM
	order_ticket_detail d
	WHERE
	1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]>
	AND d.local_m > 1
	) AS a
	)
	UNION ALL
	SELECT
	SUM(f.totalInvestment) AS totalInvestment
	FROM
	order_ticket_info_his f
	WHERE
	f.id IN (
	SELECT DISTINCT
	(a.tid)
	FROM
	(
	SELECT
	d.tid
	FROM
	order_ticket_detail_his d
	WHERE
	1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]>
	AND d.local_m > 1
	UNION ALL
	SELECT
	d.tid
	FROM
	order_ticket_detail d
	WHERE
	1 = 1 <![CDATA[ AND d.payouttime >= #{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]>
	AND d.local_m > 1
	) AS a
	)
	) AS b

</select>
<!--查询总的invest-->
<select id="detailHisQueryTotalInvest" resultMap="BaseResultMap"  parameterType="Object">
select sum(a.price_allup)as price_allup from(
	select sum(d.price_allup)as price_allup
	from order_ticket_detail_his d where 1=1 	   
	<![CDATA[ and d.payouttime  >=#{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
	and d.status !=3 and d.local_m>1
	union all
	select sum(d.price_allup)as price_allup
	from order_ticket_detail d where 1=1 	   
	<![CDATA[ and d.payouttime  >=#{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
	and d.status !=3 and d.local_m>1 
) as a
</select>

<select id="detailHisQueryTotalLib" resultMap="BaseResultMap"  parameterType="Object">
select sum(a.total_price)as total_price from(
	select sum(d.total_price)as total_price 
	from order_ticket_detail_his d where 1=1 	   
	<![CDATA[ and d.payouttime  >=#{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
	and d.status =1 and d.local_m>1
	union all
	select sum(d.total_price)as total_price 
	from order_ticket_detail d where 1=1 	   
	<![CDATA[ and d.payouttime  >=#{startDate}  ]]>  <![CDATA[ and d.payouttime < #{endDate}]]> 
	and d.status =1 and d.local_m>1
) as a
</select>

</mapper>   
