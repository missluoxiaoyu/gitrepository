<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.caiex.account.mapper.OrderTicketMapper">
		
	<sql id="Base_Column_List" >
	 order_id,ticketInfo_id,agent_id,trade_time,trade_price,trade_type,state,recycleState,recyclePrice,winMoney
    </sql>
	
 		<!--对账  根据起始时间，分页查询-->
 		<select id="getOrderTicketListWithTkidByTime" resultMap="OrderTicketResult" parameterType="java.util.Map">
			select info.tkId,ticket.* 
				from order_ticket_info info,order_ticket ticket 
					where info.id=ticket.ticketInfo_id and 
					ticket.trade_time between #{startTime} and #{endTime} and agent_id=#{agentId} limit #{page} ,#{size}
		</select>
		
		<!--对账 根据tkid查询ticket -->
		<select id="getOrderTicketByTkid" resultMap="OrderTicketResult" parameterType="String">
		select info.tkId,ticket.*  from order_ticket ticket ,order_ticket_info info where info.id=ticket.ticketInfo_id and info.tkId=#{tkId}
		</select>
		
		<!--对账  在起止时间内，ticket的个数 -->
		<select id="getTicketCount" resultType="int" parameterType="java.util.Map">
		select count(*) from order_ticket where  agent_id=#{agentid} and trade_time BETWEEN #{startTime} and #{endTime}
		</select>
 		
 		<!--渠道  根据tradetime 查询去重的agentid  -->
		<select id="queryAgentid"  resultType="java.lang.Integer" parameterType="java.util.Map">
		select distinct(agent_id) from (
	       select distinct(agent_id) from order_ticket 
	       where 
	      <![CDATA[  trade_time  >=#{startDate}  ]]>  <![CDATA[ and trade_time < #{endDate}]]>
	   union all
	      select distinct(agent_id) from order_ticket_his 
	      where 
	     <![CDATA[  trade_time  >=#{startDate}  ]]>  <![CDATA[ and trade_time < #{endDate}]]>
	    ) as a
		</select>
 		
 		<!-- 渠道 订单数 -->
 		<select id="getOrderAmount" resultType="int" parameterType="java.util.Map">
 			select count(*) from order_ticket where trade_time BETWEEN #{startDate} and #{endDate} and agent_id=#{agentId}
 		</select>
 		
 		
 	    <!--渠道  查询ticketInfo_id-->
       <select id="queryTicketInfo_id" resultMap="BaseOrderTicketResult"  parameterType="java.util.Map">
	   select <include refid="Base_Column_List"/>
	   from order_ticket where agent_id= #{agentId} and <![CDATA[  trade_time  >=#{startDate}  ]]>  <![CDATA[ and trade_time < #{endDate}]]> 
	   union all
	   select <include refid="Base_Column_List"/>
	   from order_ticket_his where agent_id= #{agentId} and <![CDATA[  trade_time  >=#{startDate}  ]]>  <![CDATA[ and trade_time < #{endDate}]]> 
	   ORDER BY agent_id DESC
       </select>
 		
 		<!--渠道报表统计 统计trade_type=1的trade_price  trade_type=1为交易成功-->
       <select id="queryBatchPrice" resultMap="BaseOrderTicketResult"  parameterType="java.util.Map">
        select if(trade_type=1,sum(trade_price),0) as trade_price from (
	    select <include refid="Base_Column_List"/>
	    from order_ticket where agent_id= #{agentId} and <![CDATA[  trade_time  >=#{startDate}  ]]>  <![CDATA[ and trade_time < #{endDate}]]> 
	    union all
	    select <include refid="Base_Column_List"/>
	    from order_ticket_his where agent_id= #{agentId} and <![CDATA[  trade_time  >=#{startDate}  ]]>  <![CDATA[ and trade_time < #{endDate}]]> 
	    )as a
      </select>
 		
 		<!--渠道报表统计 查询 回收金额-->
    <select id="queryRecycleState" resultMap="BaseOrderTicketResult" parameterType="java.util.List">
      select sum(recyclePrice) as recyclePrice from (
	   select 
	   <include refid="Base_Column_List"/>
	   from order_ticket 
	   where ticketInfo_id in 
    <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item.ticketInfoId}
    </foreach>
	 union all
		select 
	     <include refid="Base_Column_List"/>
	     from order_ticket_his 
	     where ticketInfo_id in 
     <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item.ticketInfoId}
     </foreach> 
     ) as a
    </select>
 		
 		
 		
 	<!-- order_ticket的resultMap -->	
    <resultMap type="com.caiex.account.entity.OrderTicket" id="BaseOrderTicketResult">
 	<id column="order_id" property="orderId"/>
 	<result column="ticketInfo_id" property="ticketInfoId"/>
 	<result column="agent_id" property="agentId"/>
 	<result column="trade_time" property="tradeTime"/>
 	<result column="trade_price" property="tradePrice"/>
 	<result column="trade_type" property="tradeType"/>
 	<result column="state" property="state"/>
 	<result column="recycleState" property="recycleState"/>
 	<result column="recyclePrice" property="recyclePrice"/>
 	<result column="winMoney" property="winMoney"/>
 	<result column="requestTimestamp" property="requestTimestamp"/>
	</resultMap> 	
 		
 	<!--带有tkid的resultMap 为了方便order_ticket 和 order_ticket_info 连表查询返回的结果 -->
 	<resultMap type="com.caiex.account.model.OrderTicketModel" id="OrderTicketResult">
 	<id column="order_id" property="orderId"/>
 	<result column="ticketInfo_id" property="ticketInfoId"/>
 	<result column="agent_id" property="agentId"/>
 	<result column="trade_time" property="tradeTime"/>
 	<result column="trade_price" property="tradePrice"/>
 	<result column="trade_type" property="tradeType"/>
 	<result column="state" property="state"/>
 	<result column="recycleState" property="recycleState"/>
 	<result column="recyclePrice" property="recyclePrice"/>
 	<result column="winMoney" property="winMoney"/>
 	<result column="requestTimestamp" property="requestTimestamp"/>
 	<result column="tkId" property="tkId"/>
	</resultMap> 
 
 
</mapper>   
